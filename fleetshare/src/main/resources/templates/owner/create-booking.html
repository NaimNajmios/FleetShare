<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/owner-layout}" th:with="activePage='bookings', pageTitle='Create New Booking'">

<head>
    <th:block layout:fragment="extra-css">
        <style>
            .section-divider {
                border-top: 1px solid #eee;
                margin: 1.5rem 0;
                padding-top: 1.5rem;
            }

            .section-title {
                font-size: 0.875rem;
                font-weight: 600;
                color: #6c757d;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 1rem;
            }

            .readonly-input {
                background-color: #e9ecef;
                cursor: not-allowed;
            }

            .cost-display {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1.5rem;
                border-radius: 0.5rem;
                text-align: center;
                margin-top: 1.5rem;
            }

            .cost-display .label {
                font-size: 0.875rem;
                opacity: 0.9;
                margin-bottom: 0.5rem;
            }

            .cost-display .amount {
                font-size: 2rem;
                font-weight: 700;
            }
        </style>
    </th:block>
</head>

<body>
    <div layout:fragment="content">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="font-weight-bold mb-1">Create New Booking</h3>
                        <p class="text-muted mb-0">Fill in the details below to create a manual booking</p>
                    </div>
                    <a th:href="@{/owner/bookings}" class="btn btn-outline-secondary">
                        <i class="mdi mdi-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Form Card -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <form>
                            <!-- Row 1: Client & Vehicle -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="section-title">
                                        <i class="mdi mdi-account-circle"></i> Client Information
                                    </div>
                                    <div class="form-group">
                                        <label for="renterSelect">Select Client</label>
                                        <select class="form-control" id="renterSelect" name="renterId">
                                            <option value="" selected disabled>Choose a client...</option>
                                            <option th:each="renter : ${renters}" th:value="${renter.renterId}"
                                                th:text="${renter.fullName + ' (' + renter.email + ')'}">
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="section-title">
                                        <i class="mdi mdi-car"></i> Vehicle Selection
                                    </div>
                                    <div class="form-group">
                                        <label for="vehicleSelect">Select Vehicle</label>
                                        <select class="form-control" id="vehicleSelect" name="vehicleId">
                                            <option value="" selected disabled>Choose a vehicle...</option>
                                            <option th:each="vehicle : ${vehicles}" th:value="${vehicle.vehicleId}"
                                                th:data-rate="${vehicle.ratePerDay != null ? vehicle.ratePerDay : 0}"
                                                th:text="${vehicle.brand + ' ' + vehicle.model + ' (' + vehicle.registrationNo + ')'}">
                                            </option>
                                        </select>
                                        <small class="text-muted">Daily Rate: <span id="vehicleRate">RM
                                                0.00</span></small>
                                    </div>
                                </div>
                            </div>

                            <div class="section-divider"></div>

                            <!-- Row 2: Booking Details -->
                            <div class="section-title">
                                <i class="mdi mdi-calendar-clock"></i> Booking Details
                            </div>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="startDate">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="endDate">End Date</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="paymentMethod">Payment Method</label>
                                        <select class="form-control" id="paymentMethod" name="paymentMethod">
                                            <option value="CASH">Cash</option>
                                            <option value="BANK_TRANSFER">Bank Transfer</option>
                                            <option value="CREDIT_CARD">Credit Card</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label for="duration">Duration</label>
                                        <input type="text" class="form-control readonly-input" id="duration" readonly
                                            placeholder="0 days">
                                    </div>
                                </div>
                            </div>

                            <!-- Cost Display -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="cost-display">
                                        <div class="label">Total Booking Cost</div>
                                        <div class="amount">RM <span id="totalCost">0.00</span></div>
                                        <small style="opacity: 0.8;">Calculated automatically based on daily rate and
                                            duration</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-end gap-2">
                                        <a th:href="@{/owner/bookings}" class="btn btn-light px-4">Cancel</a>
                                        <button type="button" class="btn btn-primary px-5" id="createBookingBtn">
                                            <i class="mdi mdi-check"></i> Create Booking
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block layout:fragment="extra-js">
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const vehicleSelect = document.getElementById('vehicleSelect');
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const totalCostDisplay = document.getElementById('totalCost');
                const durationDisplay = document.getElementById('duration');
                const vehicleRateDisplay = document.getElementById('vehicleRate');

                // Update vehicle rate display when vehicle is selected
                vehicleSelect.addEventListener('change', function () {
                    const selectedOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                    const rate = parseFloat(selectedOption.getAttribute('data-rate')) || 0;
                    vehicleRateDisplay.textContent = 'RM ' + rate.toFixed(2) + '/day';
                    calculateTotalCost();
                });

                function calculateTotalCost() {
                    const vehicleOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                    const rate = parseFloat(vehicleOption.getAttribute('data-rate')) || 0;

                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);

                    if (rate > 0 && startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
                        // Calculate difference in days
                        const diffTime = Math.abs(endDate - startDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        // Ensure at least 1 day
                        const days = diffDays === 0 ? 1 : diffDays;

                        // Update duration display
                        durationDisplay.value = days + ' day' + (days > 1 ? 's' : '');

                        if (days > 0) {
                            const total = days * rate;
                            totalCostDisplay.textContent = total.toFixed(2);
                        } else {
                            totalCostDisplay.textContent = '0.00';
                            durationDisplay.value = '0 days';
                        }
                    } else {
                        totalCostDisplay.textContent = '0.00';
                        durationDisplay.value = '0 days';
                    }
                }

                startDateInput.addEventListener('change', calculateTotalCost);
                endDateInput.addEventListener('change', calculateTotalCost);

                // Button click handler
                document.getElementById('createBookingBtn').addEventListener('click', function () {
                    alert('Booking creation logic will be implemented in the next phase.');
                });
            });
        </script>
    </th:block>
</body>

</html>
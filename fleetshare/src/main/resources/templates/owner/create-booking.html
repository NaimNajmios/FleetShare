<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/owner-layout}" th:with="activePage='bookings', pageTitle='Create New Booking'">

<head>
    <th:block layout:fragment="extra-css">
        <style>
            .card-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: #333;
                margin-bottom: 1.5rem;
                border-bottom: 1px solid #eee;
                padding-bottom: 0.5rem;
            }

            .form-section {
                margin-bottom: 2rem;
            }

            .readonly-input {
                background-color: #e9ecef;
                cursor: not-allowed;
            }
        </style>
    </th:block>
</head>

<body>
    <div layout:fragment="content">
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="font-weight-bold">Create New Booking</h3>
                    <a th:href="@{/owner/bookings}" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </div>

        <form>
            <!-- Card 1: Client Information -->
            <div class="row">
                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Client Information</h4>
                            <div class="form-group">
                                <label for="renterSelect">Select Client</label>
                                <select class="form-control form-select" id="renterSelect" name="renterId">
                                    <option value="" selected disabled>Select a client...</option>
                                    <option th:each="renter : ${renters}" th:value="${renter.renterId}"
                                        th:text="${renter.fullName + ' (' + renter.email + ')'}">
                                    </option>
                                </select>
                                <small class="text-muted">Select an existing registered user.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 2: Vehicle Information -->
            <div class="row">
                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Vehicle Information</h4>
                            <div class="form-group">
                                <label for="vehicleSelect">Select Vehicle</label>
                                <select class="form-control form-select" id="vehicleSelect" name="vehicleId">
                                    <option value="" selected disabled>Select a vehicle...</option>
                                    <option th:each="vehicle : ${vehicles}" th:value="${vehicle.vehicleId}"
                                        th:data-rate="${vehicle.ratePerDay != null ? vehicle.ratePerDay : 0}"
                                        th:text="${vehicle.brand + ' ' + vehicle.model + ' - [' + vehicle.registrationNo + ']'}">
                                    </option>
                                </select>
                                <small class="text-muted">Only available vehicles are shown.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card 3: Booking Details -->
            <div class="row">
                <div class="col-12 grid-margin stretch-card">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title">Booking Details</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="startDate">Start Date</label>
                                        <input type="date" class="form-control" id="startDate" name="startDate">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="endDate">End Date</label>
                                        <input type="date" class="form-control" id="endDate" name="endDate">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="totalCost">Total Cost (RM)</label>
                                        <input type="text" class="form-control readonly-input" id="totalCost"
                                            name="totalCost" readonly placeholder="0.00">
                                        <small class="text-muted">Calculated automatically based on vehicle rate and
                                            duration.</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="paymentMethod">Payment Method</label>
                                        <select class="form-control form-select" id="paymentMethod"
                                            name="paymentMethod">
                                            <option value="CASH">Cash</option>
                                            <option value="BANK_TRANSFER">Bank Transfer</option>
                                            <option value="CREDIT_CARD">Credit Card</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 d-flex justify-content-end">
                                <button type="button" class="btn btn-primary btn-lg" id="createBookingBtn">Create
                                    Booking</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <th:block layout:fragment="extra-js">
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const vehicleSelect = document.getElementById('vehicleSelect');
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                const totalCostInput = document.getElementById('totalCost');

                function calculateTotalCost() {
                    const vehicleOption = vehicleSelect.options[vehicleSelect.selectedIndex];
                    const rate = parseFloat(vehicleOption.getAttribute('data-rate')) || 0;

                    const startDate = new Date(startDateInput.value);
                    const endDate = new Date(endDateInput.value);

                    if (rate > 0 && startDate && endDate && !isNaN(startDate) && !isNaN(endDate)) {
                        // Calculate difference in days
                        const diffTime = Math.abs(endDate - startDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                        // Ensure at least 1 day if start and end are same (or handle as 0 if logic dictates)
                        // Usually rental is at least 1 day. If start == end, let's say 1 day.
                        const days = diffDays === 0 ? 1 : diffDays;

                        if (days > 0) {
                            const total = days * rate;
                            totalCostInput.value = total.toFixed(2);
                        } else {
                            totalCostInput.value = '0.00';
                        }
                    } else {
                        totalCostInput.value = '0.00';
                    }
                }

                vehicleSelect.addEventListener('change', calculateTotalCost);
                startDateInput.addEventListener('change', calculateTotalCost);
                endDateInput.addEventListener('change', calculateTotalCost);

                // Button click handler (just for UI demo since no backend logic yet)
                document.getElementById('createBookingBtn').addEventListener('click', function () {
                    alert('Booking creation logic will be implemented in the next phase.');
                });
            });
        </script>
    </th:block>
</body>

</html>
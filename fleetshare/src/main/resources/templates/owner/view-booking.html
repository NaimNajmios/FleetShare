<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/owner-layout}" th:with="activePage='bookings', pageTitle='Booking Details'">

<head>
    <th:block layout:fragment="extra-css">
        <style>
            .booking-header {
                background: white;
                padding: 1.5rem;
                border-radius: 0.5rem;
                margin-bottom: 1.5rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            }

            .booking-title h3 {
                margin-bottom: 0.25rem;
                font-weight: bold;
            }

            .booking-title p {
                margin-bottom: 0;
                color: #6c757d;
            }

            .info-card {
                background: white;
                padding: 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
                margin-bottom: 1.5rem;
            }

            .card-header-custom {
                border-bottom: 1px solid #f3f3f3;
                padding-bottom: 1rem;
                margin-bottom: 1rem;
                font-weight: bold;
                font-size: 1.1rem;
                color: #333;
            }

            .detail-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.75rem;
                border-bottom: 1px solid #f8f9fa;
                padding-bottom: 0.5rem;
            }

            .detail-row:last-child {
                border-bottom: none;
            }

            .detail-label {
                color: #6c757d;
                font-weight: 500;
            }

            .detail-value {
                font-weight: 600;
                color: #333;
                text-align: right;
            }

            .vehicle-thumbnail {
                width: 100%;
                height: 150px;
                object-fit: cover;
                border-radius: 0.5rem;
                margin-bottom: 1rem;
                background-color: #f8f9fa;
            }

            .action-panel {
                background: white;
                padding: 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            }

            .status-badge {
                padding: 0.5em 1em;
                border-radius: 0.25rem;
                font-weight: bold;
                text-transform: uppercase;
                font-size: 0.85rem;
            }

            .status-confirmed {
                background-color: #d4edda;
                color: #155724;
            }

            .status-pending {
                background-color: #fff3cd;
                color: #856404;
            }

            .status-active {
                background-color: #d1ecf1;
                color: #0c5460;
            }

            .status-completed {
                background-color: #d1ecf1;
                color: #0c5460;
            }

            .status-cancelled {
                background-color: #f8d7da;
                color: #721c24;
            }

            /* Timeline Styles */
            .timeline {
                position: relative;
                padding-left: 30px;
                margin-top: 1rem;
            }

            .timeline::before {
                content: '';
                position: absolute;
                left: 10px;
                top: 0;
                bottom: 0;
                width: 3px;
                background: linear-gradient(to bottom, #4B49AC, #7978E9);
                border-radius: 3px;
            }

            .timeline-item {
                position: relative;
                padding-bottom: 1.25rem;
            }

            .timeline-item:last-child {
                padding-bottom: 0;
            }

            .timeline-item::before {
                content: '';
                position: absolute;
                left: -24px;
                top: 5px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #4B49AC;
                border: 2px solid white;
                box-shadow: 0 0 0 2px #4B49AC;
            }

            .timeline-item.status-PENDING::before {
                background: #ffc107;
                box-shadow: 0 0 0 2px #ffc107;
            }

            .timeline-item.status-CONFIRMED::before {
                background: #28a745;
                box-shadow: 0 0 0 2px #28a745;
            }

            .timeline-item.status-ACTIVE::before {
                background: #17a2b8;
                box-shadow: 0 0 0 2px #17a2b8;
            }

            .timeline-item.status-COMPLETED::before {
                background: #6f42c1;
                box-shadow: 0 0 0 2px #6f42c1;
            }

            .timeline-item.status-CANCELLED::before {
                background: #dc3545;
                box-shadow: 0 0 0 2px #dc3545;
            }

            .timeline-item.status-DISPUTED::before {
                background: #fd7e14;
                box-shadow: 0 0 0 2px #fd7e14;
            }

            .timeline-content {
                background: #f8f9fa;
                border-radius: 6px;
                padding: 0.75rem;
                border-left: 3px solid #4B49AC;
            }

            .timeline-item.status-PENDING .timeline-content {
                border-left-color: #ffc107;
            }

            .timeline-item.status-CONFIRMED .timeline-content {
                border-left-color: #28a745;
            }

            .timeline-item.status-ACTIVE .timeline-content {
                border-left-color: #17a2b8;
            }

            .timeline-item.status-COMPLETED .timeline-content {
                border-left-color: #6f42c1;
            }

            .timeline-item.status-CANCELLED .timeline-content {
                border-left-color: #dc3545;
            }

            .timeline-item.status-DISPUTED .timeline-content {
                border-left-color: #fd7e14;
            }

            .timeline-status {
                margin-bottom: 0.35rem;
            }

            .timeline-status .status-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }

            .timeline-time {
                font-size: 0.7rem;
                color: #6c757d;
                display: block;
            }

            .timeline-actor {
                font-size: 0.7rem;
                color: #6c757d;
                word-break: break-word;
            }

            .timeline-remarks {
                margin-top: 0.35rem;
                font-style: italic;
                color: #495057;
                font-size: 0.75rem;
            }

            .badge-pending {
                background-color: #fff3cd;
                color: #856404;
            }

            .badge-confirmed {
                background-color: #d4edda;
                color: #155724;
            }

            .badge-active {
                background-color: #d1ecf1;
                color: #0c5460;
            }

            .badge-completed {
                background-color: #e2d5f1;
                color: #6f42c1;
            }

            .badge-cancelled {
                background-color: #f8d7da;
                color: #721c24;
            }

            .badge-disputed {
                background-color: #ffe5d0;
                color: #fd7e14;
            }
        </style>
    </th:block>
</head>

<body>
    <div layout:fragment="content">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="booking-header">
                    <div class="booking-title">
                        <h3>Booking Details</h3>
                        <p>Panoramic view of Booking ID: <span th:text="${booking.bookingId}">24</span></p>
                    </div>
                    <div>
                        <span th:text="${booking.status}" th:class="'status-badge ' + 
                              (${booking.status == 'CONFIRMED'} ? 'status-confirmed' : 
                              (${booking.status == 'PENDING'} ? 'status-pending' : 
                              (${booking.status == 'ACTIVE'} ? 'status-active' : 
                              (${booking.status == 'COMPLETED'} ? 'status-completed' : 
                              (${booking.status == 'CANCELLED'} ? 'status-cancelled' : '')))))">
                            CONFIRMED
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Info Cards -->
            <div class="col-lg-8">
                <!-- Booking Information -->
                <div class="info-card">
                    <div class="card-header-custom">Booking Information</div>
                    <div class="row">
                        <div class="col-md-4">
                            <img th:src="${booking.vehicleImageUrl != null and !booking.vehicleImageUrl.startsWith('https://img/') ? booking.vehicleImageUrl : '/images/vehicle-placeholder.png'}"
                                alt="Vehicle Thumbnail" class="vehicle-thumbnail">
                        </div>
                        <div class="col-md-8">
                            <div class="detail-row">
                                <span class="detail-label">Booking Date</span>
                                <span class="detail-value"
                                    th:text="${#temporals.format(booking.createdAt, 'MMMM dd, yyyy')}">June 20,
                                    2025</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Duration</span>
                                <span class="detail-value">
                                    <span th:text="${#temporals.format(booking.startDate, 'MMM dd')}">Jun 23</span> -
                                    <span th:text="${#temporals.format(booking.endDate, 'MMM dd, yyyy')}">Jun 25,
                                        2025</span>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Total Cost</span>
                                <span class="detail-value"
                                    th:text="${booking.totalCost != null ? 'RM ' + #numbers.formatDecimal(booking.totalCost, 1, 'COMMA', 2, 'POINT') : 'N/A'}">RM
                                    360.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Information -->
                <div class="info-card">
                    <div class="card-header-custom">Payment Information</div>
                    <div class="detail-row">
                        <span class="detail-label">Status</span>
                        <span class="detail-value"
                            th:text="${booking.paymentStatus != null ? booking.paymentStatus : 'PENDING'}">CONFIRMED</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Method</span>
                        <span class="detail-value"
                            th:text="${booking.paymentMethod != null ? booking.paymentMethod : 'N/A'}">Bank
                            Transfer</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Invoice Number</span>
                        <span class="detail-value"
                            th:text="${booking.invoiceNumber != null ? booking.invoiceNumber : 'N/A'}">INV-2025-06-24</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Verification</span>
                        <span class="detail-value">
                            <a th:if="${booking.proofOfPaymentUrl != null}" th:href="${booking.proofOfPaymentUrl}"
                                target="_blank" class="text-primary">View Proof</a>
                            <span th:unless="${booking.proofOfPaymentUrl != null}" class="text-muted">No proof
                                uploaded</span>
                        </span>
                    </div>
                </div>

                <!-- Entity References -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-card h-100">
                            <div class="card-header-custom">Client Information</div>
                            <div class="detail-row">
                                <span class="detail-label">Name</span>
                                <span class="detail-value" th:text="${booking.renterName}">Ahmad Zulkifli</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Email</span>
                                <span class="detail-value" th:text="${booking.renterEmail}">email@example.com</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Client ID</span>
                                <span class="detail-value" th:text="${booking.renterId}">2000</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-card h-100">
                            <div class="card-header-custom">Vehicle Information</div>
                            <div class="detail-row">
                                <span class="detail-label">Vehicle</span>
                                <span class="detail-value"
                                    th:text="${booking.vehicleBrand + ' ' + booking.vehicleModel}">Perodua Myvi</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Reg No.</span>
                                <span class="detail-value" th:text="${booking.vehicleRegistrationNo}">WUX 5815</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Vehicle ID</span>
                                <span class="detail-value" th:text="${booking.vehicleId}">1</span>
                            </div>
                            <div class="mt-3 text-right">
                                <a th:href="@{/owner/vehicles/view/{id}(id=${booking.vehicleId})}"
                                    class="btn btn-sm btn-outline-primary">View Vehicle</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Action Panel -->
            <div class="col-lg-4">
                <div class="action-panel">
                    <div class="card-header-custom">Workflow Actions</div>

                    <!-- PENDING Status Actions -->
                    <div th:if="${booking.status == 'PENDING'}" class="mb-3">
                        <p class="text-muted small mb-2">This booking is awaiting confirmation.</p>
                        <button class="btn btn-success btn-block mb-2" data-bs-toggle="modal"
                            data-bs-target="#confirmModal">
                            <i class="mdi mdi-check-circle"></i> Confirm Booking
                        </button>
                        <button class="btn btn-outline-danger btn-block" data-bs-toggle="modal"
                            data-bs-target="#cancelModal">
                            <i class="mdi mdi-close-circle"></i> Cancel Booking
                        </button>
                    </div>

                    <!-- CONFIRMED Status Actions -->
                    <div th:if="${booking.status == 'CONFIRMED'}" class="mb-3">
                        <p class="text-muted small mb-2">Booking confirmed. Ready for pickup.</p>
                        <button class="btn btn-primary btn-block mb-2" data-bs-toggle="modal"
                            data-bs-target="#activeModal">
                            <i class="mdi mdi-car-key"></i> Mark as Active (Picked Up)
                        </button>
                        <button class="btn btn-outline-danger btn-block" data-bs-toggle="modal"
                            data-bs-target="#cancelModal">
                            <i class="mdi mdi-close-circle"></i> Cancel Booking
                        </button>
                    </div>

                    <!-- ACTIVE Status Actions -->
                    <div th:if="${booking.status == 'ACTIVE'}" class="mb-3">
                        <p class="text-muted small mb-2">Rental in progress.</p>
                        <button class="btn btn-success btn-block mb-2" data-bs-toggle="modal"
                            data-bs-target="#completeModal">
                            <i class="mdi mdi-check-all"></i> Mark as Completed (Returned)
                        </button>
                        <button class="btn btn-outline-warning btn-block" data-bs-toggle="modal"
                            data-bs-target="#disputeModal">
                            <i class="mdi mdi-alert-circle"></i> Report Issue
                        </button>
                    </div>

                    <!-- DISPUTED Status Actions -->
                    <div th:if="${booking.status == 'DISPUTED'}" class="mb-3">
                        <p class="text-muted small mb-2">This booking has an open dispute.</p>
                        <button class="btn btn-success btn-block mb-2" data-bs-toggle="modal"
                            data-bs-target="#completeModal">
                            <i class="mdi mdi-check-all"></i> Resolve & Complete
                        </button>
                        <button class="btn btn-outline-danger btn-block" data-bs-toggle="modal"
                            data-bs-target="#cancelModal">
                            <i class="mdi mdi-close-circle"></i> Cancel & Refund
                        </button>
                    </div>

                    <!-- COMPLETED Status -->
                    <div th:if="${booking.status == 'COMPLETED'}" class="mb-3">
                        <div class="alert alert-success mb-0">
                            <i class="mdi mdi-check-circle"></i> This booking has been completed.
                        </div>
                    </div>

                    <!-- CANCELLED Status -->
                    <div th:if="${booking.status == 'CANCELLED'}" class="mb-3">
                        <div class="alert alert-danger mb-0">
                            <i class="mdi mdi-close-circle"></i> This booking has been cancelled.
                        </div>
                    </div>

                    <hr>

                    <a th:href="@{/owner/bookings/edit/{id}(id=${booking.bookingId})}"
                        class="btn btn-outline-primary btn-block mb-2">
                        <i class="mdi mdi-pencil"></i> Edit Booking Details
                    </a>
                    <button class="btn btn-outline-secondary btn-block" onclick="window.print()">
                        <i class="mdi mdi-printer"></i> Print Booking Details
                    </button>
                </div>

                <!-- Status Timeline -->
                <div class="info-card mt-3">
                    <div class="card-header-custom">Status Timeline</div>

                    <div th:if="${!#lists.isEmpty(statusLogs)}" class="timeline">
                        <div th:each="log : ${statusLogs}" th:class="'timeline-item status-' + ${log.status}">
                            <div class="timeline-content">
                                <div class="timeline-status">
                                    <span th:if="${log.status == 'PENDING'}"
                                        class="status-badge badge-pending">Pending</span>
                                    <span th:if="${log.status == 'CONFIRMED'}"
                                        class="status-badge badge-confirmed">Confirmed</span>
                                    <span th:if="${log.status == 'ACTIVE'}"
                                        class="status-badge badge-active">Active</span>
                                    <span th:if="${log.status == 'COMPLETED'}"
                                        class="status-badge badge-completed">Completed</span>
                                    <span th:if="${log.status == 'CANCELLED'}"
                                        class="status-badge badge-cancelled">Cancelled</span>
                                    <span th:if="${log.status == 'DISPUTED'}"
                                        class="status-badge badge-disputed">Disputed</span>
                                </div>
                                <div class="timeline-actor" th:text="'By: ' + ${log.actorName}">By: admin@example.com
                                </div>
                                <div class="timeline-time"
                                    th:text="${#temporals.format(log.timestamp, 'dd MMM yyyy HH:mm')}">01 Jan 2024 10:00
                                </div>
                                <div th:if="${log.remarks != null && !log.remarks.isEmpty()}" class="timeline-remarks"
                                    th:text="${log.remarks}">Remarks</div>
                            </div>
                        </div>
                    </div>

                    <div th:if="${#lists.isEmpty(statusLogs)}" class="no-data">
                        <i class="mdi mdi-timeline-text" style="font-size: 2rem;"></i>
                        <p>No status changes recorded yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Booking Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="mdi mdi-check-circle me-2"></i>Confirm Booking</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/owner/bookings/{id}/status(id=${booking.bookingId})}" method="POST">
                    <input type="hidden" name="status" value="CONFIRMED">
                    <div class="modal-body">
                        <p>Confirm this booking?</p>
                        <div class="form-group">
                            <label class="form-label">Remarks (optional)</label>
                            <textarea name="remarks" class="form-control" rows="2"
                                placeholder="Add any notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success"><i class="mdi mdi-check"></i> Confirm
                            Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mark as Active Modal -->
    <div class="modal fade" id="activeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="mdi mdi-car-key me-2"></i>Mark as Active</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/owner/bookings/{id}/status(id=${booking.bookingId})}" method="POST">
                    <input type="hidden" name="status" value="ACTIVE">
                    <div class="modal-body">
                        <p>Mark this booking as active? (Vehicle picked up)</p>
                        <div class="form-group">
                            <label class="form-label">Remarks (optional)</label>
                            <textarea name="remarks" class="form-control" rows="2"
                                placeholder="Add any notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary"><i class="mdi mdi-car-key"></i> Mark as
                            Active</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mark as Completed Modal -->
    <div class="modal fade" id="completeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="mdi mdi-check-all me-2"></i>Mark as Completed</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/owner/bookings/{id}/status(id=${booking.bookingId})}" method="POST">
                    <input type="hidden" name="status" value="COMPLETED">
                    <div class="modal-body">
                        <p>Mark this booking as completed? (Vehicle returned)</p>
                        <div class="form-group">
                            <label class="form-label">Remarks (optional)</label>
                            <textarea name="remarks" class="form-control" rows="2"
                                placeholder="Add any notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success"><i class="mdi mdi-check-all"></i> Complete
                            Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Report Issue (Dispute) Modal -->
    <div class="modal fade" id="disputeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="mdi mdi-alert-circle me-2"></i>Report Issue</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/owner/bookings/{id}/status(id=${booking.bookingId})}" method="POST">
                    <input type="hidden" name="status" value="DISPUTED">
                    <div class="modal-body">
                        <p>Report an issue with this booking?</p>
                        <div class="form-group">
                            <label class="form-label">Issue Details <span class="text-danger">*</span></label>
                            <textarea name="remarks" class="form-control" rows="3" placeholder="Describe the issue..."
                                required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning"><i class="mdi mdi-alert-circle"></i> Report
                            Issue</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Cancel Booking Modal -->
    <div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="mdi mdi-close-circle me-2"></i>Cancel Booking</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/owner/bookings/{id}/status(id=${booking.bookingId})}" method="POST">
                    <input type="hidden" name="status" value="CANCELLED">
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="mdi mdi-alert"></i> This action cannot be undone.
                        </div>
                        <p>Are you sure you want to cancel this booking?</p>
                        <div class="form-group">
                            <label class="form-label">Cancellation Reason <span class="text-danger">*</span></label>
                            <textarea name="remarks" class="form-control" rows="2"
                                placeholder="Reason for cancellation..." required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Go Back</button>
                        <button type="submit" class="btn btn-danger"><i class="mdi mdi-close-circle"></i> Cancel
                            Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>

</html>
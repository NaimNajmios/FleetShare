<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/renter-layout}" th:with="activePage='vehicles', pageTitle='Vehicle Details'">

<head>
    <th:block layout:fragment="extra-css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <style>
            :root {
                --primary-color: #4B49AC;
                --text-dark: #2C3E50;
                --text-muted: #6c757d;
                --bg-light: #F4F7FA;
            }

            body {
                background-color: var(--bg-light);
            }

            .details-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem 1rem;
            }

            .back-nav {
                margin-bottom: 1.5rem;
            }

            .back-link {
                color: var(--text-muted);
                text-decoration: none;
                font-weight: 500;
                transition: color 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .back-link:hover {
                color: var(--primary-color);
            }

            /* Image Gallery/Hero */
            .hero-image-card {
                background: white;
                border-radius: 1rem;
                overflow: hidden;
                box-shadow: 0 2px 12px rgba(0,0,0,0.04);
                margin-bottom: 2rem;
                position: relative;
                height: 400px;
                background-color: #e9ecef;
            }

            .hero-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .status-badge {
                position: absolute;
                top: 1rem;
                left: 1rem;
                padding: 0.5rem 1rem;
                border-radius: 50px;
                font-weight: 600;
                font-size: 0.85rem;
                z-index: 10;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }

            .status-available {
                background: #dcfce7;
                color: #166534;
            }

            .status-unavailable {
                background: #fee2e2;
                color: #b91c1c;
            }

            /* Section Cards */
            .info-card {
                background: white;
                border-radius: 1rem;
                padding: 2rem;
                box-shadow: 0 2px 12px rgba(0,0,0,0.04);
                margin-bottom: 2rem;
            }

            .section-title {
                font-size: 1.1rem;
                font-weight: 700;
                color: var(--text-dark);
                margin-bottom: 1.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            /* Specs Grid */
            .specs-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 1.5rem;
            }

            .spec-box {
                background: #f8f9fa;
                padding: 1rem;
                border-radius: 0.75rem;
                text-align: center;
                transition: transform 0.2s;
            }

            .spec-box:hover {
                transform: translateY(-2px);
                background: #fff;
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            }

            .spec-icon {
                font-size: 1.25rem;
                color: var(--primary-color);
                margin-bottom: 0.5rem;
                display: block;
            }

            .spec-label {
                font-size: 0.75rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                display: block;
                margin-bottom: 0.25rem;
            }

            .spec-value {
                font-weight: 600;
                color: var(--text-dark);
                font-size: 0.95rem;
            }

            /* Owner & Location */
            .owner-preview {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .owner-avatar {
                width: 56px;
                height: 56px;
                background: #e0e7ff;
                color: var(--primary-color);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
            }

            .map-container {
                height: 250px;
                border-radius: 0.75rem;
                overflow: hidden;
                border: 1px solid #e9ecef;
            }

            /* Booking Sidebar (Sticky) */
            .booking-sidebar {
                position: sticky;
                top: 100px;
                z-index: 100;
            }

            .price-tag {
                font-size: 2.5rem;
                font-weight: 800;
                color: var(--primary-color);
                line-height: 1;
                margin-bottom: 0.5rem;
            }

            .price-period {
                font-size: 1rem;
                color: var(--text-muted);
                font-weight: 500;
            }

            .feature-list {
                list-style: none;
                padding: 0;
                margin: 1.5rem 0;
            }

            .feature-list li {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                margin-bottom: 0.75rem;
                color: #495057;
                font-size: 0.95rem;
            }

            .feature-list i {
                color: #10b981;
            }

            .book-btn {
                display: block;
                width: 100%;
                padding: 1rem;
                background: var(--primary-color);
                color: white;
                text-align: center;
                text-decoration: none;
                border-radius: 0.75rem;
                font-weight: 600;
                font-size: 1.1rem;
                transition: all 0.2s;
                box-shadow: 0 4px 12px rgba(75, 73, 172, 0.2);
            }

            .book-btn:hover {
                background: #3f3e91;
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(75, 73, 172, 0.3);
                color: white;
            }

            /* Mobile Bottom Bar */
            .mobile-bottom-bar {
                display: none;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 1rem 1.5rem;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
                z-index: 1000;
                align-items: center;
                justify-content: space-between;
                border-top: 1px solid #e9ecef;
            }

            @media (max-width: 991px) {
                .hero-image-card {
                    height: 250px;
                    border-radius: 0;
                    margin: -2rem -1.5rem 1.5rem -1.5rem;
                    width: calc(100% + 3rem);
                }

                .details-container {
                    padding-bottom: 100px; /* Space for bottom bar */
                }

                .booking-sidebar {
                    display: none; /* Hide sidebar on mobile */
                }

                .mobile-bottom-bar {
                    display: flex;
                }

                .status-badge {
                    top: 1rem;
                    left: 2.5rem; /* Adjust for container padding */
                }
            }
        </style>
    </th:block>
</head>

<body>
    <main layout:fragment="content">
        <div class="details-container">
            <!-- Breadcrumb -->
            <nav class="back-nav" aria-label="Breadcrumb">
                <a href="/renter/vehicles" class="back-link">
                    <i class="fas fa-arrow-left"></i> Back to Browse Vehicles
                </a>
            </nav>

            <div class="row g-4">
                <!-- Left Column: Content -->
                <div class="col-lg-8">
                    <!-- Hero Image -->
                    <div class="hero-image-card">
                        <span class="status-badge"
                            th:classappend="${vehicle.status == 'AVAILABLE' ? 'status-available' : 'status-unavailable'}"
                            th:text="${vehicle.status}">
                            AVAILABLE
                        </span>

                        <img th:if="${vehicle.vehicleImageUrl != null}" th:src="${vehicle.vehicleImageUrl}"
                            alt="Vehicle Image" class="hero-image">
                        <div th:unless="${vehicle.vehicleImageUrl != null}"
                             class="d-flex align-items-center justify-content-center h-100 bg-light text-muted">
                            <i class="fas fa-car fa-4x"></i>
                        </div>
                    </div>

                    <!-- Header (Mobile/Tablet View mostly, but good for structure) -->
                    <div class="mb-4">
                        <h4 class="text-muted mb-1 text-uppercase" style="letter-spacing: 1px; font-size: 0.9rem;" th:text="${vehicle.brand}">Brand</h4>
                        <h1 class="fw-bold text-dark mb-0" th:text="${vehicle.model}">Model Name</h1>
                        <div class="d-flex align-items-center gap-2 mt-2 text-muted">
                            <i class="fas fa-map-marker-alt text-primary"></i>
                            <span th:text="${vehicle.city + ', ' + vehicle.state}">Location</span>
                        </div>
                    </div>

                    <!-- Specifications -->
                    <div class="info-card">
                        <h3 class="section-title"><i class="fas fa-cogs text-primary"></i> Vehicle Specifications</h3>
                        <div class="specs-grid">
                            <div class="spec-box">
                                <i class="fas fa-car-side spec-icon"></i>
                                <span class="spec-label">Category</span>
                                <span class="spec-value" th:text="${vehicle.category}">Sedan</span>
                            </div>
                            <div class="spec-box">
                                <i class="fas fa-gas-pump spec-icon"></i>
                                <span class="spec-label">Fuel Type</span>
                                <span class="spec-value" th:text="${vehicle.fuelType}">Petrol</span>
                            </div>
                            <div class="spec-box">
                                <i class="fas fa-cog spec-icon"></i>
                                <span class="spec-label">Transmission</span>
                                <span class="spec-value" th:text="${vehicle.transmissionType}">Auto</span>
                            </div>
                            <div class="spec-box">
                                <i class="fas fa-calendar spec-icon"></i>
                                <span class="spec-label">Year</span>
                                <span class="spec-value" th:text="${vehicle.manufacturingYear}">2022</span>
                            </div>
                            <div class="spec-box">
                                <i class="fas fa-tachometer-alt spec-icon"></i>
                                <span class="spec-label">Mileage</span>
                                <span class="spec-value" th:text="${vehicle.mileage + ' km'}">20k km</span>
                            </div>
                            <div class="spec-box">
                                <i class="fas fa-users spec-icon"></i>
                                <span class="spec-label">Capacity</span>
                                <!-- Logic for seats based on category -->
                                <span class="spec-value" th:with="cat=${vehicle.category}"
                                      th:text="${cat == 'MPV' ? '7 Seats' : (cat == 'Coupe' ? '2 Seats' : '5 Seats')}">
                                    5 Seats
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Owner & Location -->
                    <div class="info-card">
                        <h3 class="section-title"><i class="fas fa-store text-primary"></i> Fleet Owner & Location</h3>

                        <div class="owner-preview">
                            <div class="owner-avatar">
                                <i class="fas fa-building"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">
                                    <a th:href="@{/renter/owners/{id}(id=${vehicle.fleetOwnerId})}" class="text-dark text-decoration-none fw-bold"
                                       th:text="${vehicle.ownerBusinessName}">Owner Name</a>
                                    <i th:if="${vehicle.ownerIsVerified}" class="fas fa-check-circle text-success ms-1" title="Verified Owner"></i>
                                </h5>
                                <div class="text-muted small">
                                    <i class="fas fa-phone-alt me-1"></i>
                                    <span th:text="${vehicle.ownerContactPhone}">Contact</span>
                                </div>
                            </div>
                        </div>

                        <!-- Map -->
                        <div th:if="${vehicle.ownerLatitude != null and vehicle.ownerLongitude != null}" class="map-container">
                             <div id="owner-map" class="h-100 w-100"
                                  th:data-lat="${vehicle.ownerLatitude}"
                                  th:data-lng="${vehicle.ownerLongitude}"
                                  th:data-name="${vehicle.ownerBusinessName}">
                            </div>
                        </div>
                        <div th:unless="${vehicle.ownerLatitude != null and vehicle.ownerLongitude != null}"
                             class="map-container d-flex align-items-center justify-content-center bg-light text-muted">
                            <span><i class="fas fa-map-marker-slash me-2"></i> Location map unavailable</span>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Sticky Booking Card -->
                <div class="col-lg-4">
                    <div class="booking-sidebar">
                        <div class="info-card">
                            <div class="d-flex align-items-baseline gap-2 mb-3">
                                <div class="price-tag" th:text="'RM' + ${vehicle.ratePerDay}">RM120</div>
                                <span class="price-period">/ day</span>
                            </div>

                            <hr class="text-muted opacity-25">

                            <ul class="feature-list">
                                <li><i class="fas fa-check-circle"></i> Instant Confirmation</li>
                                <li><i class="fas fa-check-circle"></i> Free Cancellation (24h)</li>
                                <li><i class="fas fa-check-circle"></i> Basic Insurance Included</li>
                                <li><i class="fas fa-check-circle"></i> 24/7 Roadside Support</li>
                            </ul>

                            <a th:href="@{/renter/vehicles/{id}/book(id=${vehicle.vehicleId})}"
                               class="book-btn pulse-button">
                                Choose Dates & Book
                            </a>

                            <div class="text-center mt-3">
                                <small class="text-muted">No payment required today</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Bar -->
        <div class="mobile-bottom-bar">
            <div>
                <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">Daily Rate</small>
                <div class="d-flex align-items-baseline gap-1">
                    <span class="fw-bold text-primary h4 m-0" th:text="'RM' + ${vehicle.ratePerDay}">RM120</span>
                    <small class="text-muted">/day</small>
                </div>
            </div>
            <a th:href="@{/renter/vehicles/{id}/book(id=${vehicle.vehicleId})}" class="btn btn-primary rounded-pill px-4 py-2 fw-bold shadow-sm">
                Book Now
            </a>
        </div>
    </main>

    <th:block layout:fragment="extra-js">
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script>
            (function initOwnerMap() {
                var mapEl = document.getElementById('owner-map');
                if (mapEl && mapEl.dataset.lat && mapEl.dataset.lng) {
                    var lat = parseFloat(mapEl.dataset.lat);
                    var lng = parseFloat(mapEl.dataset.lng);
                    var businessName = mapEl.dataset.name || 'Business Location';

                    var map = L.map('owner-map', { scrollWheelZoom: false }).setView([lat, lng], 14);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                    L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup('<strong>' + businessName + '</strong><br>Business Location')
                        .openPopup();

                    // Fix map rendering issues in tabs/modals or initially hidden containers
                    setTimeout(function () { map.invalidateSize(); }, 200);
                }
            })();

            // Preserve date params for booking
            document.addEventListener('DOMContentLoaded', function() {
                const params = new URLSearchParams(window.location.search);
                const pickup = params.get('pickup');
                const returnDate = params.get('return');

                if (pickup && returnDate) {
                    const queryStr = `?pickup=${pickup}&return=${returnDate}`;

                    // Update all book buttons
                    document.querySelectorAll('a[href*="/book"]').forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && !href.includes('?')) {
                             link.setAttribute('href', href + queryStr);
                        }
                    });
                }
            });
        </script>
    </th:block>
</body>

</html>